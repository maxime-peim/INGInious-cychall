#!/bin/python3
# -*- coding: utf-8 -*-
#
# This file is part of INGInious. See the LICENSE and the COPYRIGHTS files for
# more information about the licensing of this file.

import os
import sys
import argparse
import cychall_container_api.steps
from cychall_container_api.steps import Step, EndStep

parser = argparse.ArgumentParser(formatter_class=argparse.RawTextHelpFormatter, description='Generate a flag and place it in a file.\n')
parser.add_argument('--output-dir', help="Where to generate the steps.", type=str, default="/task/student")
parser.add_argument('--input-dir', help="Where are the setup scripts for the steps.", type=str, default="/task/student/scripts")
args = parser.parse_args()

# count the number of steps
number_of_steps = cychall_container_api.steps.count_steps(args.input_dir)

try:
    # steps and users associated need to be generated from last to first
    # so user for step_i+1 exists to give permission on building step_i
    EndStep(args.output_dir).build()

    # generate each step
    for stepi in range(number_of_steps, 0, -1):
        Step(f"step{stepi}", args.input_dir, args.output_dir).build()

    # set the rights to the output directory to 770 so all step users can access their folder
    cychall_container_api.steps.fix_output_directory_permissions(args.output_dir)
        
except cychall_container_api.steps.StepGenerationError as sge:
    sys.stderr.buffer.write(str(sge).encode())
    sys.exit(2)

    
